# Create HTML with test selector, blank default, and embedded table
html_file_path = "/mnt/data/plc_dashboard_by_test.html"

assignment_options = '\n'.join(
    f'<option value="{name}">{name}</option>'
    for name in sorted(display_df["Assignment"].unique())
)

# Build embedded HTML
html_dashboard = f"""
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>PLC Hub - Filter by Test</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {{ font-family: Arial, sans-serif; margin: 20px; }}
    select, label {{ font-size: 14px; margin-right: 10px; }}
    canvas {{ max-width: 100%; margin-top: 30px; }}
    table {{ width: 100%; border-collapse: collapse; margin-top: 40px; font-size: 14px; }}
    th, td {{ border: 1px solid #ccc; padding: 8px; text-align: center; }}
    th {{ background-color: #f2f2f2; }}
  </style>
</head>
<body>

<h1>PLC Hub - Filter by Assessment</h1>

<label for="testSelect"><strong>Select Assessment(s):</strong></label>
<select id="testSelect" multiple size="10">{assignment_options}</select>

<canvas id="barChart"></canvas>
<canvas id="lineChart"></canvas>

<h2>Full Assignment Table</h2>
<table>
  <thead>
    <tr><th>Assignment</th><th>Skill</th><th>Students</th><th>%4s</th><th>%3s</th><th>%2s</th><th>%1s</th><th>% Proficient</th></tr>
  </thead>
  <tbody>
"""

# Add table rows
for _, row in display_df.iterrows():
    html_dashboard += f"<tr><td>{row['Assignment']}</td><td>{row['Skill']}</td><td>{row['Students']}</td>" \
                      f"<td>{row['%4s']}</td><td>{row['%3s']}</td><td>{row['%2s']}</td><td>{row['%1s']}</td>" \
                      f"<td>{row['% Proficient']}</td></tr>"

html_dashboard += """
  </tbody>
</table>

<script>
const data = """

# Load the data to inject as JavaScript
import json
with open("/mnt/data/common_assignments_by_skill.json") as f:
    json_data = json.load(f)

html_dashboard += json.dumps(json_data) + ";\n"

# Add script for interactivity
html_dashboard += """
const testSelect = document.getElementById('testSelect');
const barCtx = document.getElementById('barChart').getContext('2d');
const lineCtx = document.getElementById('lineChart').getContext('2d');
let barChart, lineChart;

function updateCharts() {
  const selected = Array.from(testSelect.selectedOptions).map(o => o.value);
  if (selected.length === 0) {
    if (barChart) barChart.destroy();
    if (lineChart) lineChart.destroy();
    return;
  }

  const filtered = data.filter(d => selected.includes(d.name));
  const labels = filtered.map(d => d.name);
  const skills = filtered.map(d => d.skill);

  const barData = {
    labels: ["4s", "3s", "2s", "1s"],
    datasets: filtered.map((entry, i) => ({
      label: `${entry.name} (${entry.skill})`,
      data: [entry["4s"], entry["3s"], entry["2s"], entry["1s"]],
      backgroundColor: `hsl(${i * 50 % 360}, 60%, 60%)`
    }))
  };
  if (barChart) barChart.destroy();
  barChart = new Chart(barCtx, {
    type: 'bar',
    data: barData,
    options: {
      responsive: true,
      plugins: {
        title: {
          display: true,
          text: '% Distribution by Proficiency Level'
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          max: 100,
          title: { display: true, text: '% of Students' }
        }
      }
    }
  });

  const lineData = {
    labels: labels,
    datasets: [{
      label: "% Proficient (4s+3s)",
      data: filtered.map(d => d.proficient),
      fill: false,
      borderColor: "cornflowerblue",
      tension: 0.3,
      pointRadius: 5,
      pointHoverRadius: 7
    }]
  };
  if (lineChart) lineChart.destroy();
  lineChart = new Chart(lineCtx, {
    type: 'line',
    data: lineData,
    options: {
      responsive: true,
      plugins: {
        title: { display: true, text: 'Proficiency Over Time' }
      },
      scales: {
        y: {
          beginAtZero: true,
          max: 100,
          title: { display: true, text: '% Proficient' }
        },
        x: { title: { display: true, text: 'Assignment' } }
      }
    }
  });
}

testSelect.addEventListener('change', updateCharts);
</script>

</body>
</html>
"""

# Write to file
with open(html_file_path, "w") as f:
    f.write(html_dashboard)

html_file_path
